# 运输层分组——报文段(segment)
主机间交付扩展到进程间交付被称为运输层的多路复用(transport-layer multiplexing)与多路分解(demultiplexing)
* 多路分解：将运输层报文段中的数据交付到正确的套接字
* 多路复用：在源主机从不同套接字中手收集数据块，并为每个数据块封装上首部信息从而生成报文段，将报文段传递到网络层

面向UDP套接字
<目的IP地址,目的端口号>

UDP称为无连接：在发送报文段之前，发送方和接收方的运输层实体之间没有握手

> 谷歌的Chromium浏览器实现了QUIC(Quick UDP Internet Connections)协议，通过重传以及差错检测、快速连接建立和基于速率的拥塞控制算法提供可靠性，在UDP之上作为应用层协议实现。

面向TCP套接字
<源IP地址,源端口号,目的IP地址,目的端口号>

|应用|应用层协议|下面的运输协议|
|:---:|:---:|:---:|
|电子邮件|SMTP|TCP|
|远程终端访问|Telnet|TCP|
|Web|HTTP|TCP|
|文件传输|FTP|TCP|
|远程文件服务器|NFS|通常UDP|
|流式多媒体|通常专用|UDP或TCP|
|因特网电话|通常专用|UDP或TCP|
|网络管理|SNMP|通常UDP|
|名字转换|DNS|通常UDP|

## 可靠数据传输原理
1. 经完全可靠信道的可靠数据传输：rdt1.0
2. 经具有比特差错信道的可靠数据传输: rdt2.0, rdt2.1, rdt2.2
2. 经具有比特差错的丢包信道的可靠数据传输: rdt3.0(比特交替协议)

## 自动重传请求(Automatic Repeat reQuest,ARQ)协议
* 差错检测
* 接收方反馈
* 重传

## 解决流水线的差错恢复
* 回退N步(Go-Back-N, GBN),滑动窗口协议
允许发送方发送多个分组而不需等待确认，不能超过某个最大允许数N

* 选择重传(Selective Repeat, SR)
让发送方仅重传那些它怀疑在接收方出错的分组而避免不必要的重传

接收方将确认一个正确接收的分组而不管其是否按序。失序的分组将被缓存知道所有丢失分组皆被收到为止。

### 快速重传
发送方通常可在超时事件发生之前通过注意冗余ACK(duplicate ACK)来检测丢包情况

比期望序号大的失序报文段到达，检测出间隙，接收方立即发送冗余ACK,指示下一个期待字节的序列（其为间隔的低端的序号）

如果发送方接收到对相同数据的3个冗余ACK，说明根在这个以被确认过3次的报文段之后的报文段已经丢失，就执行快速重传(fast retransmit

## 流量控制
TCP发送方可能因为IP网络的拥塞而被遏制；这种形式的发送方的控制被称为拥塞控制(congestion control)。

* TCP通过让发送方维护一个称为接收窗口的变量来提供流量控制

### SYN洪泛攻击
在TCP三次握手中，服务器为了响应一个收到的SYN,分配并初始化连接变量和缓存，然后服务器发送一个SYNACK进行响应，并等待来自客户的ACK报文段。如果某客户不发送ACK来完成第三步，最终服务器将终止该半开连接并回收资源。在SYN洪泛攻击中，攻击者发送大量的TCP SYN报文段而不完成第三步，服务器不断为这些半开连接分配资源，导致服务器的连接资源被消耗殆尽。

防御方法：SYN cookie
> 服务器收到一个SYN报文段后，不会为该报文段生成一个半开连接，而是生成一个初始TCP序列号，该序列号是SYN报文段的源和目的IP地址与端口号以及仅有该服务器知道的秘密数的一个复杂函数(散列函数)。服务器发送具有这种特殊初始序列号的SYNACK分组。**重要的是，服务器并不记忆该cookie或任何对应于SYN的其他状态信息**

TCP拥塞控制算法
* 加性增、乘性减(Additive-Increase, Multiplicative-Decrease, AIMD)

1. 慢启动

cwnd的值通常初始置为一个MSS的较小值
慢启动阈值ssthresh设置为cwnd/2，即当检测到拥塞时将ssthresh置为拥塞窗口值的一半
2. 拥塞避免

cwnd的值大约是上次遇到拥塞时的值的一半，此时每个RTT只将cwnd的值增加一个MSS。

当超时出现时，cwnd的值被设置为1个MSS，ssthresh的值被更新为cwnd值的一半。
3. 快速恢复